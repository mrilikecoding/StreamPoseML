version: '3'

services:
  stream_pose_ml_api:
    # image: mrilikecoding/stream_pose_ml_api:latest
    build: # for local development 
      context: ./stream_pose_ml 
    ports:
      - "5001:5001"
    networks:
      - app-tier
    volumes:
      - ./stream_pose_ml:/usr/src/app
      - ${PWD}/data/trained_models:/usr/src/app/data/trained_models
    environment:
      - FLASK_APP=run.py
    command: >
      bash -c "python run.py"

  web_ui:
    # image: mrilikecoding/stream_pose_ml_web_ui:latest
    build: # for local development 
      context: ./web_ui 
    depends_on:
      - stream_pose_ml_api
    ports:
      - "3000:3000"
    stdin_open: true
    networks:
      - app-tier
    entrypoint: >
          bash -c "yarn build  && yarn serve --host --port 3000"
    volumes:
      - ./web_ui:/usr/src/app/my-app
      - ./web_ui/logs:/root/.npm/_logs
      - /usr/src/app/my-app/node_modules # anonymous persistent volume to prevent local machine override

  mlflow:
    build:
      context: ./mlflow 
    networks:
      - app-tier
    ports:
      - "5002:5002"  # Expose Flask API
    volumes:
      - ./mlflow/app.py:/app.py  # Mount the app.py file
      - ./mlflow/models:/models  # Mount the models directory

networks:
  app-tier:
    driver: bridge